<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="generator" content="Hugo 0.101.0" />
  <link rel="canonical" href="http://3implieschaos.org/post/tech/devops/chef-cookbook-example/" />

  
    
    <meta name="description" content="A quick and dirty example of creating a chef cookbook with rspec tests.">
  

  <link rel="apple-touch-icon" sizes="180x180" href="http://3implieschaos.org/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="http://3implieschaos.org/favicon-32x32.png"> 
  <link rel="icon" type="image/png" sizes="16x16" href="http://3implieschaos.org/favicon-16x16.png"> 
  <link rel="manifest" href="http://3implieschaos.org/site.webmanifest"> 
  <link rel="mask-icon" href="http://3implieschaos.org/safari-pinned-tab.svg" color="#000000"> 
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">

  <style>
    body {
      visibility: hidden;
      opacity: 0;
    }
  </style>

  <style id="darkTheme">
    .intro-and-nav,
    .main-and-footer {
      filter: invert(100%);
    }

    * {
      background-color: inherit
    }

    img:not([src*=".svg"]),
    .colors,
    iframe,
    .demo-container {
      filter: invert(100%);
    }
  </style>

  <link rel="stylesheet" href="/css/prism.css" media="none" onload="this.media='all';">

  
  
  <link rel="stylesheet" type="text/css" href="/css/styles.css">

  

  
  
  <title>DevOps 101: Chef Cookbook with Testing | tdj28</title>
</head>

  <body>
    <a href="#main">skip to content</a>
    <noscript>
  <style>
    body {
      visibility: visible;
      opacity: 1;
    }
  </style>
</noscript>

    <svg style="display: none">
  <symbol id="bookmark" viewBox="0 0 40 50">
   <g transform="translate(2266 3206.2)">
    <path style="stroke:currentColor;stroke-width:3.2637;fill:none" d="m-2262.2-3203.4-.2331 42.195 16.319-16.318 16.318 16.318.2331-42.428z"/>
   </g>
  </symbol>

  <symbol id="w3c" viewBox="0 0 127.09899 67.763">
   <text font-size="83" style="font-size:83px;font-family:Trebuchet;letter-spacing:-12;fill-opacity:0" letter-spacing="-12" y="67.609352" x="-26.782778">W3C</text>
   <text font-size="83" style="font-size:83px;font-weight:bold;font-family:Trebuchet;fill-opacity:0" y="67.609352" x="153.21722" font-weight="bold">SVG</text>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m33.695.377 12.062 41.016 12.067-41.016h8.731l-19.968 67.386h-.831l-12.48-41.759-12.479 41.759h-.832l-19.965-67.386h8.736l12.061 41.016 8.154-27.618-3.993-13.397h8.737z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m91.355 46.132c0 6.104-1.624 11.234-4.862 15.394-3.248 4.158-7.45 6.237-12.607 6.237-3.882 0-7.263-1.238-10.148-3.702-2.885-2.47-5.02-5.812-6.406-10.022l6.82-2.829c1.001 2.552 2.317 4.562 3.953 6.028 1.636 1.469 3.56 2.207 5.781 2.207 2.329 0 4.3-1.306 5.909-3.911 1.609-2.606 2.411-5.738 2.411-9.401 0-4.049-.861-7.179-2.582-9.399-1.995-2.604-5.129-3.912-9.397-3.912h-3.327v-3.991l11.646-20.133h-14.062l-3.911 6.655h-2.493v-14.976h32.441v4.075l-12.31 21.217c4.324 1.385 7.596 3.911 9.815 7.571 2.22 3.659 3.329 7.953 3.329 12.892z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m125.21 0 1.414 8.6-5.008 9.583s-1.924-4.064-5.117-6.314c-2.693-1.899-4.447-2.309-7.186-1.746-3.527.73-7.516 4.938-9.258 10.13-2.084 6.21-2.104 9.218-2.178 11.978-.115 4.428.58 7.043.58 7.043s-3.04-5.626-3.011-13.866c.018-5.882.947-11.218 3.666-16.479 2.404-4.627 5.954-7.404 9.114-7.728 3.264-.343 5.848 1.229 7.841 2.938 2.089 1.788 4.213 5.698 4.213 5.698l4.94-9.837z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m125.82 48.674s-2.208 3.957-3.589 5.48c-1.379 1.524-3.849 4.209-6.896 5.555-3.049 1.343-4.646 1.598-7.661 1.306-3.01-.29-5.807-2.032-6.786-2.764-.979-.722-3.486-2.864-4.897-4.854-1.42-2-3.634-5.995-3.634-5.995s1.233 4.001 2.007 5.699c.442.977 1.81 3.965 3.749 6.572 1.805 2.425 5.315 6.604 10.652 7.545 5.336.945 9.002-1.449 9.907-2.031.907-.578 2.819-2.178 4.032-3.475 1.264-1.351 2.459-3.079 3.116-4.108.487-.758 1.276-2.286 1.276-2.286l-1.276-6.644z"/>
  </symbol>

  <symbol id="tag" viewBox="0 0 177.16535 177.16535">
    <g transform="translate(0 -875.2)">
     <path style="fill-rule:evenodd;stroke-width:0;fill:currentColor" d="m159.9 894.3-68.79 8.5872-75.42 77.336 61.931 60.397 75.429-76.565 6.8495-69.755zm-31.412 31.835a10.813 10.813 0 0 1 1.8443 2.247 10.813 10.813 0 0 1 -3.5174 14.872l-.0445.0275a10.813 10.813 0 0 1 -14.86 -3.5714 10.813 10.813 0 0 1 3.5563 -14.863 10.813 10.813 0 0 1 13.022 1.2884z"/>
    </g>
  </symbol>

  <symbol id="balloon" viewBox="0 0 141.73228 177.16535">
   <g transform="translate(0 -875.2)">
    <g>
     <path style="fill:currentColor" d="m68.156 882.83-.88753 1.4269c-4.9564 7.9666-6.3764 17.321-5.6731 37.378.36584 10.437 1.1246 23.51 1.6874 29.062.38895 3.8372 3.8278 32.454 4.6105 38.459 4.6694-.24176 9.2946.2879 14.377 1.481 1.2359-3.2937 5.2496-13.088 8.886-21.623 6.249-14.668 8.4128-21.264 10.253-31.252 1.2464-6.7626 1.6341-12.156 1.4204-19.764-.36325-12.93-2.1234-19.487-6.9377-25.843-2.0833-2.7507-6.9865-7.6112-7.9127-7.8436-.79716-.20019-6.6946-1.0922-6.7755-1.0248-.02213.0182-5.0006-.41858-7.5248-.22808l-2.149-.22808h-3.3738z"/>
     <path style="fill:currentColor" d="m61.915 883.28-3.2484.4497c-1.7863.24724-3.5182.53481-3.8494.63994-2.4751.33811-4.7267.86957-6.7777 1.5696-.28598 0-1.0254.20146-2.3695.58589-5.0418 1.4418-6.6374 2.2604-8.2567 4.2364-6.281 7.6657-11.457 18.43-12.932 26.891-1.4667 8.4111.71353 22.583 5.0764 32.996 3.8064 9.0852 13.569 25.149 22.801 37.517 1.3741 1.841 2.1708 2.9286 2.4712 3.5792 3.5437-1.1699 6.8496-1.9336 10.082-2.3263-1.3569-5.7831-4.6968-21.86-6.8361-33.002-.92884-4.8368-2.4692-14.322-3.2452-19.991-.68557-5.0083-.77707-6.9534-.74159-15.791.04316-10.803.41822-16.162 1.5026-21.503 1.4593-5.9026 3.3494-11.077 6.3247-15.852z"/>
     <path style="fill:currentColor" d="m94.499 885.78c-.10214-.0109-.13691 0-.0907.0409.16033.13489 1.329 1.0675 2.5976 2.0723 6.7003 5.307 11.273 14.568 12.658 25.638.52519 4.1949.24765 14.361-.5059 18.523-2.4775 13.684-9.7807 32.345-20.944 53.519l-3.0559 5.7971c2.8082.76579 5.7915 1.727 8.9926 2.8441 11.562-11.691 18.349-19.678 24.129-28.394 7.8992-11.913 11.132-20.234 12.24-31.518.98442-10.02-1.5579-20.876-6.7799-28.959-.2758-.4269-.57803-.86856-.89617-1.3166-3.247-6.13-9.752-12.053-21.264-16.131-2.3687-.86369-6.3657-2.0433-7.0802-2.1166z"/>
     <path style="fill:currentColor" d="m32.52 892.22c-.20090-.13016-1.4606.81389-3.9132 2.7457-11.486 9.0476-17.632 24.186-16.078 39.61.79699 7.9138 2.4066 13.505 5.9184 20.562 5.8577 11.77 14.749 23.219 30.087 38.74.05838.059.12188.1244.18052.1838 1.3166-.5556 2.5965-1.0618 3.8429-1.5199-.66408-.32448-1.4608-1.3297-3.8116-4.4602-5.0951-6.785-8.7512-11.962-13.051-18.486-5.1379-7.7948-5.0097-7.5894-8.0586-13.054-6.2097-11.13-8.2674-17.725-8.6014-27.563-.21552-6.3494.13041-9.2733 1.775-14.987 2.1832-7.5849 3.9273-10.986 9.2693-18.07 1.7839-2.3656 2.6418-3.57 2.4409-3.7003z"/>
     <path style="fill:currentColor" d="m69.133 992.37c-6.2405.0309-12.635.76718-19.554 2.5706 4.6956 4.7759 9.935 10.258 12.05 12.625l4.1272 4.6202h11.493l3.964-4.4516c2.0962-2.3541 7.4804-7.9845 12.201-12.768-8.378-1.4975-16.207-2.6353-24.281-2.5955z"/>
     <rect style="stroke-width:0;fill:currentColor" ry="2.0328" height="27.746" width="22.766" y="1017.7" x="60.201"/>
    </g>
   </g>
  </symbol>

  <symbol id="info" viewBox="0 0 41.667 41.667">
   <g transform="translate(-37.035 -1004.6)">
    <path style="stroke-linejoin:round;stroke:currentColor;stroke-linecap:round;stroke-width:3.728;fill:none" d="m76.25 1030.2a18.968 18.968 0 0 1 -23.037 13.709 18.968 18.968 0 0 1 -13.738 -23.019 18.968 18.968 0 0 1 23.001 -13.768 18.968 18.968 0 0 1 13.798 22.984"/>
    <g transform="matrix(1.1146 0 0 1.1146 -26.276 -124.92)">
     <path style="stroke:currentColor;stroke-linecap:round;stroke-width:3.728;fill:none" d="m75.491 1039.5v-8.7472"/>
     <path style="stroke-width:0;fill:currentColor" transform="scale(-1)" d="m-73.193-1024.5a2.3719 2.3719 0 0 1 -2.8807 1.7142 2.3719 2.3719 0 0 1 -1.718 -2.8785 2.3719 2.3719 0 0 1 2.8763 -1.7217 2.3719 2.3719 0 0 1 1.7254 2.8741"/>
    </g>
   </g>
  </symbol>

  <symbol id="warning" viewBox="0 0 48.430474 41.646302">
    <g transform="translate(-1.1273 -1010.2)">
     <path style="stroke-linejoin:round;stroke:currentColor;stroke-linecap:round;stroke-width:4.151;fill:none" d="m25.343 1012.3-22.14 37.496h44.28z"/>
     <path style="stroke:currentColor;stroke-linecap:round;stroke-width:4.1512;fill:none" d="m25.54 1027.7v8.7472"/>
     <path style="stroke-width:0;fill:currentColor" d="m27.839 1042.8a2.3719 2.3719 0 0 1 -2.8807 1.7143 2.3719 2.3719 0 0 1 -1.718 -2.8785 2.3719 2.3719 0 0 1 2.8763 -1.7217 2.3719 2.3719 0 0 1 1.7254 2.8741"/>
    </g>
  </symbol>

  <symbol id="menu" viewBox="0 0 50 50">
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="0" x="0"/>
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="20" x="0"/>
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="40" x="0"/>
   </symbol>

   <symbol id="link" viewBox="0 0 50 50">
    <g transform="translate(0 -1002.4)">
     <g transform="matrix(.095670 0 0 .095670 2.3233 1004.9)">
      <g>
       <path style="stroke-width:0;fill:currentColor" d="m452.84 192.9-128.65 128.65c-35.535 35.54-93.108 35.54-128.65 0l-42.881-42.886 42.881-42.876 42.884 42.876c11.845 11.822 31.064 11.846 42.886 0l128.64-128.64c11.816-11.831 11.816-31.066 0-42.9l-42.881-42.881c-11.822-11.814-31.064-11.814-42.887 0l-45.928 45.936c-21.292-12.531-45.491-17.905-69.449-16.291l72.501-72.526c35.535-35.521 93.136-35.521 128.64 0l42.886 42.881c35.535 35.523 35.535 93.141-.001 128.66zm-254.28 168.51-45.903 45.9c-11.845 11.846-31.064 11.817-42.881 0l-42.884-42.881c-11.845-11.821-11.845-31.041 0-42.886l128.65-128.65c11.819-11.814 31.069-11.814 42.884 0l42.886 42.886 42.876-42.886-42.876-42.881c-35.54-35.521-93.113-35.521-128.65 0l-128.65 128.64c-35.538 35.545-35.538 93.146 0 128.65l42.883 42.882c35.51 35.54 93.11 35.54 128.65 0l72.496-72.499c-23.956 1.597-48.092-3.784-69.474-16.283z"/>
      </g>
     </g>
    </g>
  </symbol>

  <symbol id="doc" viewBox="0 0 35 45">
   <g transform="translate(-147.53 -539.83)">
    <path style="stroke:currentColor;stroke-width:2.4501;fill:none" d="m149.38 542.67v39.194h31.354v-39.194z"/>
    <g style="stroke-width:25" transform="matrix(.098003 0 0 .098003 133.69 525.96)">
     <path d="m220 252.36h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
     <path style="stroke:currentColor;stroke-width:25;fill:none" d="m220 409.95h200"/>
     <path d="m220 488.74h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
     <path d="m220 331.15h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
    </g>
   </g>
 </symbol>

 <symbol id="tick" viewBox="0 0 177.16535 177.16535">
  <g transform="translate(0 -875.2)">
   <rect style="stroke-width:0;fill:currentColor" transform="rotate(30)" height="155" width="40" y="702.99" x="556.82"/>
   <rect style="stroke-width:0;fill:currentColor" transform="rotate(30)" height="40" width="90.404" y="817.99" x="506.42"/>
  </g>
 </symbol>
</svg>

    <div class="wrapper">
      <header class="intro-and-nav" role="banner">
  <div>
    <div class="intro">
      <a
        class="logo"
        href="http://3implieschaos.org/"
        aria-label="tdj28 home page"
      >
        
          <h1>tdj28</h1>
        
      </a>
      <p class="library-desc">
         Potentially helpful notes, tips, and how-tos. 
      </p>
    </div>
    <nav id="patterns-nav" class="patterns" role="navigation">
  <h2 class="vh">Main navigation</h2>
  <button id="menu-button" aria-expanded="false">
    <svg viewBox="0 0 50 50" aria-hidden="true" focusable="false">
      <use href="#menu"></use>
    </svg>
    Menu
  </button>
  
  <ul id="patterns-list">
  
    <li class="pattern">
      
      
      
      
      <a href="/" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use href="#bookmark"></use>
        </svg>
        <span class="text">Home</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/post/" aria-current="page">
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use href="#bookmark"></use>
        </svg>
        <span class="text">Blog</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/tags/" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use href="#bookmark"></use>
        </svg>
        <span class="text">Tags</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/about/" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use href="#bookmark"></use>
        </svg>
        <span class="text">About</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/index.xml" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use href="#bookmark"></use>
        </svg>
        <span class="text">RSS</span>
      </a>
    </li>
  
  </ul>
</nav>
    
  </div>
</header>

      <div class="main-and-footer">
        <div>
          
  <main id="main">
    <h1>
      <svg class="bookmark-icon" aria-hidden="true" viewBox="0 0 40 50" focusable="false">
        <use href="#bookmark"></use>
      </svg>
      DevOps 101: Chef Cookbook with Testing
    </h1>

    <div class="date">
      
      
      <strong>Publish date: </strong>Jan 28, 2017
      
        
      
    </div>

    
      <div class="tags">
        <strong>Tags: </strong>
        <ul aria-label="tags">
          
            <li>
              <svg class="tag-icon" aria-hidden="true" viewBox="0 0 177.16535 177.16535" focusable="false">
                <use href="#tag"></use>
              </svg>
              
              <a href="/tags/devops/">devops</a>
            </li>
          
            <li>
              <svg class="tag-icon" aria-hidden="true" viewBox="0 0 177.16535 177.16535" focusable="false">
                <use href="#tag"></use>
              </svg>
              
              <a href="/tags/sre/">sre</a>
            </li>
          
        </ul>
      </div>
    

    
  <nav class="toc" aria-labelledby="toc-heading">
    <strong id="toc-heading">Table of Contents</strong>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#yet-another-chef-tutorial">Yet another chef tutorial</a>
          <ul>
            <li><a href="#getting-started">Getting started</a>
              <ul>
                <li><a href="#installing-chefdk">Installing ChefDK</a></li>
                <li><a href="#initiating-your-cookbook">Initiating your cookbook</a></li>
                <li><a href="#pushing-to-github">Pushing to GitHub</a></li>
              </ul>
            </li>
            <li><a href="#create-the-core-configuration">Create the core configuration</a>
              <ul>
                <li><a href="#creating-a-story-for-the-cookbook">Creating a story for the cookbook</a>
                  <ul>
                    <li><a href="#updating-all-packages">Updating all packages</a></li>
                    <li><a href="#creating-a-c9-user">Creating a C9 User</a></li>
                    <li><a href="#installing-motd">Installing MOTD</a></li>
                    <li><a href="#installing-packages">Installing Packages</a></li>
                    <li><a href="#installing-cloud-9-ide">Installing Cloud 9 IDE</a></li>
                    <li><a href="#installing-supervisor">Installing Supervisor</a></li>
                  </ul>
                </li>
                <li><a href="#putting-it-all-together">Putting it all together</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#source-code">Source Code</a></li>
        <li><a href="#future-steps">Future Steps</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </nav>



    <h2 id="introduction">Introduction</h2>
<h3 id="yet-another-chef-tutorial">Yet another chef tutorial</h3>
<p>You can of course skip this step if you are familiar with Chef to a great enough degree, but in the spirit of making this a self-contained walkthrough, we will start from the ground up.</p>
<h4 id="getting-started">Getting started</h4>
<h5 id="installing-chefdk">Installing ChefDK</h5>
<p>It is widely considered best practice to use <a href="https://downloads.chef.io/chefdk">ChefDK</a>, and this walkthrough uses ChefDK exclusively.</p>
<ul>
<li>On Mac, install <a href="http://brew.sh/">HomeBrew</a> and run <code>brew cask install chefdk</code></li>
<li>On Linux, <a href="https://downloads.chef.io/chefdk">download a package</a> corresponding to your distro and install accordingly.</li>
<li>On Windows: Run Linux as a Virtual Machine, get Docker for Windows, or <em>try</em> using Bash on Windows, but this walkthrough doesn&rsquo;t support Windows-based development.</li>
</ul>
<h5 id="initiating-your-cookbook">Initiating your cookbook</h5>
<p>Let&rsquo;s start with the following command:</p>
<pre><code class="language-bash">chef generate cookbook c9_ide_chef
</code></pre>
<p>This command generates a template for a cookbook. Note that we use and underline in the name instead of a hyphen as hyphens can be problematic for chef in some circumstances. We now have a folder with the following content:</p>
<pre><code class="language-bash">├── .gitignore
├── .kitchen.yml
├── Berksfile
├── README.md
├── chefignore
├── metadata.rb
├── recipes
│   └── default.rb
├── spec
│   ├── spec_helper.rb
│   └── unit
│       └── recipes
│           └── default_spec.rb
└── test
    └── smoke
        └── default
            └── default_test.rb
</code></pre>
<p>It also  creates a <code>.delivery</code> and a <code>.git</code> folder whose contents are omitted here for clarity.</p>
<p>The second command creates an attribute folder which we can populate with default attributes for our cookbook, and the third line creates a default template for a &ldquo;message of the day&rdquo; to be displayed when first logging in.</p>
<p>The <code>.git</code> directory is useful and we will use it as the basis for a new repo in github repo.</p>
<h5 id="pushing-to-github">Pushing to GitHub</h5>
<p>Now that we have the skeleton for our cookbook, we should start pushing to GitHub for version-control. On GitHub, create a public repo called c9_ide. Then run the following commands:</p>
<pre><code class="language-bash">git add .
git commit -m &quot;First commit&quot;
git remote add origin git@github.com:YOUR_GITHUB_USERNAME/c9_ide_chef.git
git push -u origin master
</code></pre>
<p>Now the stage is set and we are ready to make the cookbook actually do something.</p>
<h4 id="create-the-core-configuration">Create the core configuration</h4>
<h5 id="creating-a-story-for-the-cookbook">Creating a story for the cookbook</h5>
<p>So far we&rsquo;ve seen how to set up the cookbook, but we don&rsquo;t quite know what we are going to do with it. Now is a good time to set up some goals for our cookbook:</p>
<ul>
<li>It should update all packages before doing anything else</li>
<li>It should create a message of the day that gives basic information about the server to a user logging in</li>
<li>It should install basic security packages and other utilities</li>
<li>It should install the packages needed to run Cloud 9 IDE</li>
<li>It should pull and install Cloud 9 IDE</li>
</ul>
<h6 id="updating-all-packages">Updating all packages</h6>
<p>Just for fun, we are going to make our cookbook work for both Debian and RHEL variations of Linux. Under the recipes folder, let&rsquo;s create a recipe file called <code>update.rb</code> and give it contents:</p>
<pre><code class="language-ruby"># Update system to start with
case node['platform']


when 'debian', 'ubuntu'

    execute 'AptUpdateUpgrade' do
        command &quot;apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get upgrade -y&quot;
    end

when 'redhat', 'centos', 'fedora'

     # Update all packages
    execute 'UpdateYum' do
        command &quot;yum -y update&quot;
    end

    # Add Fedora's Extra Packages for Enterprise Linux
    execute 'GetEPELRepo' do
        command &quot;rpm -iUvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-9.noarch.rpm&quot;
        not_if &quot;rpm -qa | grep -qx 'epel-release-7-9.noarch'&quot;
    end

end
</code></pre>
<p>in the <code>default.rb</code> recipe, add the line:</p>
<pre><code class="language-ruby">include_recipe 'c9_ide::update'
</code></pre>
<p>That&rsquo;s it for now! Before we go any further, let&rsquo;s test this. Chef has automatically added some basis for testing to your repo. Let&rsquo;s start with kitchen. This assumes you have <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> and <a href="https://www.vagrantup.com/">Vagrant</a> installed (if you don&rsquo;t, install them). At the base directory, run:</p>
<pre><code class="language-bash">kitchen create
kitchen converge
</code></pre>
<p>The first command creates the virtual machines for us to work with, and teh second command cooks Chef inside of them. It is a very convenient way to do a full test of your code before pushing to github. The converge command may take quite a while as we are updating all packages on the systems and doing it for two VMs, and Ubuntu one and a CentOS one. If all goes well, the final output looks like:</p>
<pre><code class="language-bash">Chef Client finished, 1/1 resources updated in 02 minutes 21 seconds
</code></pre>
<h6 id="creating-a-c9-user">Creating a C9 User</h6>
<p>It is rarely a good idea to run a program as root. As such, our next step is to create a user for running the Cloud 9 IDE. We start by creating a data bag. First, install knife-solo and <a href="https://github.com/thbishop/knife-solo_data_bag">knife-solo data bag</a>:</p>
<pre><code class="language-bash">chef gem install knife-solo
chef gem install knife-solo_data_bag
</code></pre>
<p>This is not entirely necessary, but that tool can be useful in other ways for making chef solo cookbooks. Then we can generate a databag and databag item:</p>
<pre><code class="language-bash">mkdir data_bags
export EDITOR=&quot;vi&quot;
knife solo data bag create users c9ide
</code></pre>
<p>In the editor that pops up, paste the following content:</p>
<pre><code class="language-json">{
  &quot;id&quot;: &quot;c9ide&quot;,
  &quot;comment&quot;: &quot;c9ide User&quot;,
  &quot;ssh_keys&quot;: [
    &quot;&quot;
  ],
  &quot;home&quot;: &quot;/home/c9ide&quot;,
  &quot;ssh_keygen&quot;: false
}
</code></pre>
<p>Next, back to <code>recipe/default.rb</code>, we can invoke the external chef recipe &ldquo;users&rdquo; to have this user installed on our system:</p>
<pre><code class="language-ruby">include_recipe 'user::data_bag'
</code></pre>
<p>To create an attributes file:</p>
<pre><code class="language-bash">chef generate attribute default
</code></pre>
<p>and in <code>attributes/default.rb</code> add the line:</p>
<pre><code class="language-ruby">default['users'] = 'c9ide'
</code></pre>
<p>This of course shows the fantastic power and utility of Chef since we can call upon a wide range of libraries already created by the chef community. Now we need to tell Chef that we are using an external library, so in our <code>metadata.rb</code> file at the top level we add the line at the end:</p>
<pre><code class="language-ruby">depends          'user'
</code></pre>
<p>At the same level there is a Berksfile with the content:</p>
<pre><code class="language-ruby">source 'https://supermarket.chef.io'

metadata
</code></pre>
<p>which tells chef to check this <code>metadata.rb</code> file for dependencies (such as the user dependency we just added) that we need to pull and make available during cooking. We&rsquo;ll show how this is done manually a bit later, but for now <code>kitchen converge</code> takes care of that.</p>
<p>Now run <code>kitchen converge</code> one more time, and you should see that the user is created.</p>
<p>Let&rsquo;s create a quick smoke test item, add:</p>
<pre><code class="language-ruby">describe user('c9ide') do
    it { should exist }
end
</code></pre>
<p>to <code>test/default/default_test.rb</code> and run</p>
<pre><code class="language-bash">kitchen verify
</code></pre>
<p>if all went well you will see:</p>
<pre><code class="language-bash"> User c9ide
     ✔  should exist
</code></pre>
<p>Now is a good time to push to github:</p>
<pre><code class="language-bash">git add .
git commit -m &quot;Adds update and users&quot;
git push origin master
</code></pre>
<h6 id="installing-motd">Installing MOTD</h6>
<p>First, let&rsquo;s generate a blank template file:</p>
<pre><code class="language-bash">chef generate template motd
</code></pre>
<p>fill with content:</p>
<pre><code class="language-bash">&lt;%= node['motd-attributes']['message'] %&gt;
The hostname of this node is &lt;%= node['hostname'] %&gt;
The IP address of this node is &lt;%= node['ipaddress'] %&gt;
</code></pre>
<p>and create a recipe file <code>recipes/motd.rb</code> with contents:</p>
<pre><code class="language-bash">template '/etc/motd' do
      source 'motd.erb'
      mode '0644'
end
</code></pre>
<p>and finally add this line to the <code>attributes/default.rb</code> file:</p>
<pre><code class="language-ruby">default['motd-attributes']['message'] = &quot;A Cloud 9 IDE server&quot;
</code></pre>
<p>We add the following tests at <code>test/smoke/default/motd_test.rb</code>:</p>
<pre><code class="language-ruby">describe directory('/etc/motd') do  # describe this directory
	its(:content) { should match /A Cloud 9 IDE server/ }
end
</code></pre>
<p>We run <code>kitchen converge</code> and <code>kitchen verify</code> again to make sure the recipe is fine, and then push to github as before.</p>
<h6 id="installing-packages">Installing Packages</h6>
<p>We are getting close to installing the Cloud9 IDE. Before doing so, we need to install some packages. Some of these packages are for security purposes, or convenience in administration, while others are needed for the Cloud 9 IDE system.</p>
<p>Create a file <code>recipe/packages.rb</code> with content:</p>
<pre><code class="language-ruby">case node['platform']
when 'debian', 'ubuntu'

    req_packages = ['fail2ban',
                    'gcc',
                    'g++',
                    'git',
                    'htop',
                    'make',
                    'nodejs',
                    'nmap',
                    'npm',
                    'sysstat',
                    'unattended-upgrades',
                    'apt-listchanges']

    req_packages.each do |packs|
      Chef::Log.info(&quot;Installing: &quot; + packs)
      package packs do
        action :install
      end
    end

    template '/etc/apt/apt.conf.d/50unattended-upgrades' do
        owner 'root'
        group 'root'
        mode '0644'
        source '50unattended-upgrades.erb'
    end

    template '/etc/apt/apt.conf.d/20auto-upgrades' do
        owner 'root'
        group 'root'
        mode '0644'
        source '20auto-upgrades.erb'
    end

when 'redhat', 'centos', 'fedora'

    req_packages = ['fail2ban',
                    'gcc-c++',
                    'git',
                    'glibc-static',
                    'htop',
                    'make',
                    'nodejs',
                    'nmap',
                    'npm',
                    'sysstat',
                    'yum-cron']

    req_packages.each do |packs|
      Chef::Log.info(&quot;Installing: &quot; + packs)
      package packs do
        action :install
      end
    end

    template '/etc/yum/yum-cron.conf' do
        owner 'root'
        group 'root'
        mode '0644'
        source 'yum-cron.conf.erb'
    end

    execute 'systemctl enable yum-cron' do
    end

    execute 'systemctl start yum-cron' do
    end

end
</code></pre>
<p>Notice that we have sneaked in automated security updates as well. For that, we require the following templates:</p>
<p><code>templates/50unattended-upgrades.erb</code>:</p>
<pre><code class="language-bash">// Automatically upgrade packages from these (origin, archive) pairs
Unattended-Upgrade::Allowed-Origins {
  &lt;% node['unattended-upgrades']['origins'].each do |origin| %&gt;
  &quot;&lt;%= origin %&gt;&quot;;
  &lt;% end %&gt;
};

// List of packages to not update
Unattended-Upgrade::Package-Blacklist {
  &quot;apache2&quot;;
  &quot;nginx&quot;;
//  &quot;libc6-dev&quot;;
//  &quot;libc6-i686&quot;;
};

// Send email to this address for problems or packages upgrades
// If empty or unset then no email is sent, make sure that you
// have a working mail setup on your system. The package 'mailx'
// must be installed or anything that provides /usr/bin/mail.
&lt;%= node['unattended-upgrades']['send_email'] ? &quot;&quot; : &quot;// &quot; %&gt;Unattended-Upgrade::Mail &quot;&lt;%= node['unattended-upgrades']['email_address'] %&gt;&quot;;

// Do automatic removal of new unused dependencies after the upgrade
// (equivalent to apt-get autoremove)
Unattended-Upgrade::Remove-Unused-Dependencies &quot;&lt;%= node['unattended-upgrades']['auto_remove'] ? &quot;true&quot; : &quot;false&quot; %&gt;&quot;;

// Automatically reboot *WITHOUT CONFIRMATION* if a
// the file /var/run/reboot-required is found after the upgrade
Unattended-Upgrade::Automatic-Reboot &quot;&lt;%= node['unattended-upgrades']['auto_reboot'] ? &quot;true&quot; : &quot;false&quot; %&gt;&quot;;
</code></pre>
<p><code>templates/20auto-upgrades.erb</code>:</p>
<pre><code class="language-bash">APT::Periodic::Update-Package-Lists &quot;&lt;%=node['unattended-upgrades']['update_package_lists_interval']%&gt;&quot;;
APT::Periodic::Unattended-Upgrade &quot;&lt;%=node['unattended-upgrades']['upgrade_interval']%&gt;&quot;;
</code></pre>
<p>and</p>
<p><code>templates/yum-cron.conf.erb</code>:</p>
<pre><code class="language-bash">update_cmd = security
apply_updates = yes
</code></pre>
<pre><code class="language-bash">default['unattended-upgrades']['update_package_lists_interval'] = &quot;1&quot;
default['unattended-upgrades']['upgrade_interval'] = &quot;1&quot;
default['unattended-upgrades']['origins'] = ['${distro_id} ${distro_codename}-security']
default['unattended-upgrades']['send_email'] = false
default['unattended-upgrades']['email_address'] = &quot;test@example.com&quot;
default['unattended-upgrades']['auto_remove'] = false
default['unattended-upgrades']['auto_reboot'] = false
</code></pre>
<p>and of course, our inspec test in <code>test/smoke/default/packages_test.rb</code>:</p>
<pre><code class="language-ruby">if os[:family] == 'debian'
  	req_packages = ['fail2ban',
                    'gcc',
                    'g++',
                    'git',
                    'htop',
                    'make',
                    'nodejs',
                    'nmap',
                    'npm',
                    'sysstat',
                    'unattended-upgrades',
                    'apt-listchanges']

    req_packages.each do |packs|
      describe package(packs) do
      	it { should be_installed }
      end
    end

else

    req_packages = ['fail2ban',
                    'gcc-c++',
                    'git',
                    'glibc-static',
                    'htop',
                    'make',
                    'nodejs',
                    'nmap',
                    'npm',
                    'sysstat',
                    'yum-cron']

    req_packages.each do |packs|
      describe package(packs) do
      	it { should be_installed }
      end
    end
end
</code></pre>
<h6 id="installing-cloud-9-ide">Installing Cloud 9 IDE</h6>
<p>Chef has a built-in git resource that we can use to pull the Cloud 9 IDE code.</p>
<p>The test for this section will be rather brief:</p>
<pre><code class="language-ruby">describe directory('/home/c9ide/core/README.md') do  # describe this directory
	its(:content) { should match /^Cloud9/ }
end
</code></pre>
<p>and the reason is that we can really verify whether or not this section succeeded in the next section on running via supervisor.</p>
<p>The code for this section, in <code>/recipes/c9ide.rb</code>, is:</p>
<pre><code class="language-ruby">git &quot;/home/c9ide/core&quot; do
   repository 'https://github.com/c9/core.git'
   reference 'master'
   action :sync
end

case node['platform']
when 'debian', 'ubuntu'
	bash 'create nodejs link' do
		code &lt;&lt;-EOH
		ln -s /usr/bin/nodejs /usr/bin/node
		EOH
		not_if { ::File.exist?('/usr/bin/node') }
	end
end

bash 'install_cloud9ide' do
   cwd '/home/c9ide/core/'
   user 'root'
   code &lt;&lt;-EOH
     scripts/install-sdk.sh
     EOH
   environment 'PREFIX' =&gt; '/usr/local'
end
</code></pre>
<h6 id="installing-supervisor">Installing Supervisor</h6>
<p>Finally, we want to leave our server running Cloud 9 IDE after provisioning it. Supervisor is a fantastic way to do so, though of course not the only way and perhaps not even the best way, but it is a convenient and production-ready solution (though this development kit version of Cloud 9 IDE is not production material and is meant for development purposes).</p>
<p>In <code>recipes/supervisor.rb</code>:</p>
<pre><code class="language-ruby">package 'supervisor' do
    action :install
end

case node['platform']
when 'debian', 'ubuntu'

	cookbook_file '/etc/supervisor/conf.d/cloud9ide.conf' do
	  source 'c9ide.conf'
	  owner 'root'
	  group 'root'
	  mode '0755'
	  action :create
	end

	execute 'start supervisor' do
	  command 'service supervisor start'
	end

	execute 'reload supervisor' do
	  command 'supervisorctl update'
	end

when 'redhat', 'centos', 'fedora'

	cookbook_file '/etc/supervisord.d/cloud9ide.ini' do
	  source 'c9ide.conf'
	  owner 'root'
	  group 'root'
	  mode '0755'
	  action :create
	end

	execute 'start supervisor' do
	  command 'service supervisord start'
	end

	execute 'reload supervisor' do
	  command 'supervisorctl update'
	end
end
</code></pre>
<p>and finally add this to the <code>c9ide_test.rb</code> test file:</p>
<pre><code class="language-ruby">describe port(9999) do
  it { should be_listening }
end
</code></pre>
<h5 id="putting-it-all-together">Putting it all together</h5>
<p>The default recipe should now look like this:</p>
<pre><code class="language-ruby">include_recipe 'c9_ide::update'
include_recipe 'user::data_bag'
include_recipe 'c9_ide::motd'
include_recipe 'c9_ide::packages'
include_recipe 'c9_ide::cloud9ide'
include_recipe 'c9_ide::supervisor'
</code></pre>
<p>we run a final <code>kitchen converge</code>; if all goes well, we follow up with a final <code>kitchen verify</code>:</p>
<pre><code class="language-bash">-----&gt; Starting Kitchen (v1.14.2)
-----&gt; Setting up &lt;default-ubuntu-1604&gt;...
       Finished setting up &lt;default-ubuntu-1604&gt; (0m0.00s).
-----&gt; Verifying &lt;default-ubuntu-1604&gt;...
       Loaded

Target:  ssh://vagrant@127.0.0.1:2222


  File /home/c9ide/core/README.md
     ✔  content should match /^Cloud9/
  Port 9999
     ✔  should be listening
  User c9ide
     ✔  should exist
  File /etc/motd
     ✔  content should match /A Cloud 9 IDE server/
  System Package
     ✔  fail2ban should be installed
  System Package
     ✔  gcc should be installed
  System Package
     ✔  g++ should be installed
  System Package
     ✔  git should be installed
  System Package
     ✔  htop should be installed
  System Package
     ✔  make should be installed
  System Package
     ✔  nodejs should be installed
  System Package
     ✔  nmap should be installed
  System Package
     ✔  npm should be installed
  System Package
     ✔  sysstat should be installed
  System Package
     ✔  unattended-upgrades should be installed
  System Package
     ✔  apt-listchanges should be installed

Test Summary: 16 successful, 0 failures, 0 skipped
       Finished verifying &lt;default-ubuntu-1604&gt; (0m1.28s).
-----&gt; Setting up &lt;default-centos-72&gt;...
       Finished setting up &lt;default-centos-72&gt; (0m0.00s).
-----&gt; Verifying &lt;default-centos-72&gt;...
       Loaded

Target:  ssh://vagrant@127.0.0.1:2200


  File /home/c9ide/core/README.md
     ✔  content should match /^Cloud9/
  Port 9999
     ✔  should be listening
  User c9ide
     ✔  should exist
  File /etc/motd
     ✔  content should match /A Cloud 9 IDE server/
  System Package
     ✔  fail2ban should be installed
  System Package
     ✔  gcc-c++ should be installed
  System Package
     ✔  git should be installed
  System Package
     ✔  glibc-static should be installed
  System Package
     ✔  htop should be installed
  System Package
     ✔  make should be installed
  System Package
     ✔  nodejs should be installed
  System Package
     ✔  nmap should be installed
  System Package
     ✔  npm should be installed
  System Package
     ✔  sysstat should be installed
  System Package
     ✔  yum-cron should be installed

Test Summary: 15 successful, 0 failures, 0 skipped
       Finished verifying &lt;default-centos-72&gt; (0m13.80s).
-----&gt; Kitchen is finished. (0m16.47s)
</code></pre>
<p>Congratulations, you have a basic working chef recipe for installing Cloud 9 IDE, tested and provisioned on both major families of Linux.</p>
<h3 id="source-code">Source Code</h3>
<p>You can find the source code for this recipe on my github account <a href="https://github.com/3implieschaos/c9_ide_chef/tree/PartI">here</a>.</p>
<h3 id="future-steps">Future Steps</h3>
<p>We took some shortcuts and avoided some best practices for convenience here. Ideally we would like some unit tests and to pull in more community recipes. For example, the supervisor chef cookbook could be used here instead of dealing with that in a platform case.</p>
<p>In the forthcoming Part II, we will use Puppet, a widely used alternative to Chef, to provision a server that runs the Cloud 9 IDE SDK as we have here with Chef.</p>

  </main>
  <div id="disqus-container">
  
</div>


          
            <footer role="contentinfo">
  <div
  
  >
    <label for="themer">
      dark theme: <input type="checkbox" id="themer" class="vh">
      
      <span aria-hidden="true"></span>
    </label>
  </div>
  
    Made with <a href="https://gohugo.io/">Hugo</a>. Themed by <a href="https://github.com/zwbetz-gh/cupper-hugo-theme">Cupper</a>.
  
</footer>

          
        </div>
      </div>
    </div>
    

<script src="/js/dom-scripts.js"></script>  

<script src="/js/prism.js"></script>



<script src="/js/search.7aef046a0cc8b0c532f1d20087b920459bc868c936bb48a6ae221eceefca2d07.js"></script>

<link rel="stylesheet" href="/css/search.fe0cd54a21628574bff49d721c827d1bb165ab56b0f22dd55ae78addbe61c309.css"></link>




    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js" integrity="sha384-2BKqo+exmr9su6dir+qCw08N2ZKRucY4PrGQPPWU1A7FtlCGjmEGFqXCv5nyM5Ij" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>

    
  

  </body>
</html>
