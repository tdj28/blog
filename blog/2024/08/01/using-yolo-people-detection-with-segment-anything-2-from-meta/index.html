<!doctype html><html lang=en style=font-size:115%><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta name=description content="A quick and dirty example of creating a chef cookbook with rspec tests."><link rel=apple-touch-icon sizes=180x180 href=https://www.tdj28.org//images/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.tdj28.org//images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.tdj28.org//images/favicon-16x16.png><meta name=keywords content='hugo latex theme blog texify texify2 texify3 michael neuper'><link rel=stylesheet href=/katex/katex.min.css><script defer defer src=/katex/katex.min.js></script><script defer src=/katex/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><meta property="og:url" content="https://www.tdj28.org/blog/2024/08/01/using-yolo-people-detection-with-segment-anything-2-from-meta/"><meta property="og:site_name" content="TDJ28"><meta property="og:title" content="Using YOLO people detection with Segment Anything 2 from META"><meta property="og:description" content="A quick and dirty example of creating a chef cookbook with rspec tests."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-08-01T19:21:05-07:00"><meta property="article:modified_time" content="2024-08-04T15:17:06-07:00"><meta property="article:tag" content="Ml"><meta property="article:tag" content="Sam2"><meta property="article:tag" content="Python"><meta property="article:tag" content="Yolo"><link rel=canonical href=https://www.tdj28.org/blog/2024/08/01/using-yolo-people-detection-with-segment-anything-2-from-meta/><meta itemprop=name content="Using YOLO people detection with Segment Anything 2 from META"><meta itemprop=description content="A quick and dirty example of creating a chef cookbook with rspec tests."><meta itemprop=datePublished content="2024-08-01T19:21:05-07:00"><meta itemprop=dateModified content="2024-08-04T15:17:06-07:00"><meta itemprop=wordCount content="2099"><meta itemprop=keywords content="Ml,Sam2,Python,Yolo"><link rel=stylesheet href=/css/common.min.34f60e2333422e738b86e195a0bf4d119a27c761ea0e3f065acc94818eb81b78.css integrity="sha256-NPYOIzNCLnOLhuGVoL9NEZonx2HqDj8GWsyUgY64G3g=" crossorigin=anonymous><link rel=stylesheet href=/css/content.min.abafa49a3586683e185d210e8ce738faf8e41ad0649c62dd0193ad3e113d4f58.css integrity="sha256-q6+kmjWGaD4YXSEOjOc4+vjkGtBknGLdAZOtPhE9T1g=" crossorigin=anonymous><link rel=stylesheet href=/css/alerts.min.352561072eb67d9a0ed2b2302cd947c2a2472565dcec07f7aaaa378f4cb1cd48.css integrity="sha256-NSVhBy62fZoO0rIwLNlHwqJHJWXc7Af3qqo3j0yxzUg=" crossorigin=anonymous><title>Using YOLO people detection with Segment Anything 2 from META - TDJ28</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Using YOLO people detection with Segment Anything 2 from META"><meta name=twitter:description content="A quick and dirty example of creating a chef cookbook with rspec tests."><link rel=stylesheet href=/css/single.min.2c2574d9e8af69a9179e48afd33ba67bcdb66b6b016348527ee45ae452fe03d2.css integrity="sha256-LCV02eivaakXnkiv0zume822a2sBY0hSfuRa5FL+A9I=" crossorigin=anonymous><link rel=stylesheet href=/css/single.min.78a121b7d7a160420f9daab0ea13add66c37b9c44f27bba07b27207e2b0975d2.css integrity="sha256-eKEht9ehYEIPnaqw6hOt1mw3ucRPJ7ugeycgfisJddI=" crossorigin=anonymous><link rel=stylesheet href=/css/alerts.min.352561072eb67d9a0ed2b2302cd947c2a2472565dcec07f7aaaa378f4cb1cd48.css integrity="sha256-NSVhBy62fZoO0rIwLNlHwqJHJWXc7Af3qqo3j0yxzUg=" crossorigin=anonymous><link rel=stylesheet href=/css/blog-images.min.393fdc10547572cb9729b3ee9dbf63390d39cdc54c4594ff0b5655766997f533.css integrity="sha256-OT/cEFR1csuXKbPunb9jOQ05zcVMRZT/C1ZVdmmX9TM=" crossorigin=anonymous></head><body><div id=wrapper><header id=header><h1><a href=https://www.tdj28.org/>TDJ28</a>
<button id=dark-mode-toggle class=dark-mode-toggle aria-label="Toggle theme">
<svg width="2rem" height="2rem" viewBox="0 0 496 496"><path fill="currentColor" d="M8 256C8 393 119 504 256 504S504 393 504 256 393 8 256 8 8 119 8 256zM256 440V72a184 184 0 010 368z" transform="translate(-8 -8)"/></svg></button></h1><nav><span class=nav-bar-item><span class=icon><svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M17 11H16a1 1 0 000 2h1a1 1 0 000-2zm0 4H16a1 1 0 000 2h1a1 1 0 000-2zM11 9h6a1 1 0 000-2H11a1 1 0 000 2zM21 3H7A1 1 0 006 4V7H3A1 1 0 002 8V18a3 3 0 003 3H18a4 4 0 004-4V4A1 1 0 0021 3zM6 18a1 1 0 01-2 0V9H6zm14-1a2 2 0 01-2 2H7.82A3 3 0 008 18V5H20zm-9-4h1a1 1 0 000-2H11a1 1 0 000 2zm0 4h1a1 1 0 000-2H11a1 1 0 000 2z"/></svg>
</span><a class=link href=/blog/>Blog</a>
</span><span class=nav-bar-item><span class=icon><svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M2.88 16.88a3 3 0 000 4.24 3 3 0 004.24.0 3 3 0 00-4.24-4.24zm2.83 2.83a1 1 0 01-1.42-1.42 1 1 0 011.42.0 1 1 0 010 1.42zM5 12a1 1 0 000 2 5 5 0 015 5 1 1 0 002 0 7 7 0 00-7-7zM5 8a1 1 0 000 2 9 9 0 019 9 1 1 0 002 0 11.08 11.08.0 00-3.22-7.78A11.08 11.08.0 005 8zm10.61.39A15.11 15.11.0 005 4 1 1 0 005 6 13 13 0 0118 19a1 1 0 002 0A15.11 15.11.0 0015.61 8.39z"/></svg>
</span><a class=link href=/index.xml>RSS</a>
</span><span class=nav-bar-item><span class=icon><svg width="1em" height="1em" viewBox="0 0 24 24" data-name="Layer 1"><path d="M10.07031 20.50291a1.00008 1.00008.0 00-1.18115-.9834c-1.30908.24024-2.96191.27637-3.40137-.958a5.70754 5.70754.0 00-1.83691-2.415 1.20073 1.20073.0 01-.1665-.10938 1 1 0 00-.93067-.64551H2.54883a.99965.99965.0 00-1 .99512c-.00391.81543.811 1.33789 1.1416 1.51465a4.4408 4.4408.0 01.92383 1.35937c.36426 1.02344 1.42285 2.57617 4.46582 2.376.001.03516.00195.06836.00244.09863l.00439.26758a1 1 0 002 0l-.00488-.31836C10.07715 21.4951 10.07031 21.22068 10.07031 20.50291zm10.667-15.126c.03174-.125.063-.26367.09034-.41992a6.27792 6.27792.0 00-.40821-3.293 1.002 1.002.0 00-.61572-.58007c-.356-.12012-1.67041-.35645-4.18408 1.25a13.86918 13.86918.0 00-6.354.0C6.76221.751 5.45459.9658 5.10205 1.07908a.99744.99744.0 00-.63135.584 6.3003 6.3003.0 00-.40332 3.35644c.02442.12793.05078.2461.07813.35449A6.26928 6.26928.0 002.89014 9.20311a8.42168 8.42168.0 00.04248.92187c.334 4.60254 3.334 5.98438 5.42431 6.459-.04345.125-.083.25878-.11816.40039a1.00023 1.00023.0 001.94238.47851 1.6784 1.6784.0 01.46778-.87793.99947.99947.0 00-.5459-1.74512c-3.4541-.39453-4.95362-1.80175-5.1792-4.89843a6.61076 6.61076.0 01-.03369-.73828 4.25769 4.25769.0 01.91943-2.71289 3.022 3.022.0 01.1958-.23145.99988.99988.0 00.188-1.02441A3.3876 3.3876.0 016.0381 4.6787 4.09356 4.09356.0 016.1167 3.06346a7.54263 7.54263.0 012.415 1.17968 1.00877 1.00877.0 00.82764.13282 11.77716 11.77716.0 016.17285.001 1.00549 1.00549.0 00.83056-.13769 7.572 7.572.0 012.40528-1.19043 4.03977 4.03977.0 01.0874 1.57812 3.205 3.205.0 01-.16895.60743.9999.9999.0 00.188 1.02441c.07715.08691.1543.18066.22363.26855A4.12186 4.12186.0 0120 9.20311a7.03888 7.03888.0 01-.0376.77734c-.22021 3.05566-1.72558 4.46387-5.1958 4.85937a1 1 0 00-.54541 1.7461 1.63079 1.63079.0 01.46631.9082 3.06079 3.06079.0 01.09229.81934v2.334C14.77 21.2949 14.77 21.78025 14.77 22.00291a1 1 0 102 0c0-.2168.0-.69238.00977-1.33984V18.31346a4.8815 4.8815.0 00-.15479-1.31153 4.25638 4.25638.0 00-.11621-.416 6.51258 6.51258.0 005.44531-6.42383A8.69677 8.69677.0 0022 9.20311 6.13062 6.13062.0 0020.7373 5.37693z"/></svg>
</span><a class=link href=https://github.com/tdj28>GitHub</a>
</span><span class=nav-bar-item><span class=icon><svg width="1em" height="1em" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.69C20.88 6.16 21.56 5.32 21.88 4.31 21.05 4.81 20.13 5.16 19.16 5.36 18.37 4.5 17.26 4 16 4c-2.35.0-4.27 1.92-4.27 4.29C11.73 8.63 11.77 8.96 11.84 9.27 8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15.0 1.49.75 2.81 1.91 3.56C3.62 10.5 2.96 10.3 2.38 10V10.03c0 2.08 1.48 3.82 3.44 4.21C5.46 14.34 5.08 14.39 4.69 14.39 4.42 14.39 4.15 14.36 3.89 14.31c.54 1.69 2.11 2.95 4 2.98-1.46 1.16-3.31 1.84-5.33 1.84C2.22 19.13 1.88 19.11 1.54 19.07 3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79 20.33 8.6 20.33 8.42 20.32 8.23 21.16 7.63 21.88 6.87 22.46 6z"/></svg>
</span><a class=link href=https://x.com/tdj11100>Twitter</a></span></nav></header><hr class=head-rule></hr><main id=main class=post><article class="content numbered-subtitles"><h2 id=introduction>Introduction</h2><p>META&rsquo;s recent release of <a href=https://github.com/facebookresearch/segment-anything-2>Segment Anything 2</a> (SAM2) as a fully open-source project,
where both the code <em>and</em> the models are open-source, opens the door for many interesting use cases. One use case is people detection and
tracking.</p><p>Suppose, for example, that I wanted to <em>detect</em> and <em>track</em> if people enter some region in my camera&rsquo;s view. The
<a href=https://github.com/ultralytics/yolov5>YOLO toolset</a> has
been widely used for people detection, and here we use it to detect people whose YOLO-created bounding box intersects with a chosen
detection region. Then we use points around the center of that bounding box as seeds for tracking those individuals with SAM2.</p><div class="alert alert-warning"><strong class=alert-title>Warning:</strong><div class=alert-content>This code is shared purely for research purposes and should not be used as-is for anything beyond education. The reliability of
these tools in production settings needs to be tested thoroughly</div></div><h3 id=code>Code</h3><p>Code for this post can be found <a href=https://github.com/tdj28/using-yolo-with-sam2-and-monocular-depth>here</a>.</p><h3 id=procedure>Procedure</h3><ul><li>Create synthetic camera footage with <a href=https://runwayml.com/>Runway ML Gen 3</a></li><li>Pick a frame early in the synthetic footage, in this case, frame 30</li><li>Designate a detection region in the image</li><li>Get people detection bounding boxes from the image</li><li>Get a subset of detection bounding boxes which intersect with the detection region</li><li>Get the center point of the detection bounding boxes in that subset, and use those as seeds for SAM2 to track those individuals through the remainder of the video</li></ul><h3 id=setup>Setup</h3><p>First, we need to set up the environment and install the required packages:</p><div class="alert alert-primary"><strong class=alert-title>Tip:</strong><div class=alert-content>The pinning of package versions here is to help ensure that this code can work as is out-of-the-box; however, you may
get better results by unpinning these versions and just using the latest code. It is generally best practice to pin packages
in <em>production</em> environments.</div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Install necessary packages</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>ultralytics</span><span class=o>==</span><span class=mf>8.2.71</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>torch</span><span class=o>==</span><span class=mf>2.4.0</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>torchvision</span><span class=o>==</span><span class=mf>0.19.0</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>torchaudio</span><span class=o>==</span><span class=mf>2.4.0</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>matplotlib</span><span class=o>==</span><span class=mf>3.9.1</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>pillow</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=n>opencv</span><span class=o>-</span><span class=n>python</span><span class=o>-</span><span class=n>headless</span><span class=o>==</span><span class=mf>4.10.0.84</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Clone the Segment Anything 2 repository and install it</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>git</span> <span class=n>clone</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>github</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>facebookresearch</span><span class=o>/</span><span class=n>segment</span><span class=o>-</span><span class=n>anything</span><span class=o>-</span><span class=mf>2.</span><span class=n>git</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>cd</span> <span class=n>segment</span><span class=o>-</span><span class=n>anything</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>pip</span> <span class=n>install</span> <span class=o>-</span><span class=n>e</span> <span class=o>.</span> <span class=o>-</span><span class=n>q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Download the pre-trained SAM2 model</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=n>wget</span> <span class=o>-</span><span class=n>q</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>dl</span><span class=o>.</span><span class=n>fbaipublicfiles</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>segment_anything_2</span><span class=o>/</span><span class=mi>072824</span><span class=o>/</span><span class=n>sam2_hiera_large</span><span class=o>.</span><span class=n>pt</span> <span class=o>-</span><span class=n>P</span> <span class=n>checkpoints</span>
</span></span></code></pre></div><h2 id=loading-and-processing-the-video>Loading and Processing the Video</h2><p>We start by converting the input video into frames. The frames will be processed to detect and segment people.</p><div class="alert alert-info"><strong class=alert-title>Info:</strong><div class=alert-content>As of the publication of this post, SAM2 only supports JPEG.</div></div><p>First we do some initial setup:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.patches</span> <span class=k>as</span> <span class=nn>patches</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.utils.misc</span> <span class=kn>import</span> <span class=n>get_sdpa_settings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.build_sam</span> <span class=kn>import</span> <span class=n>build_sam2_video_predictor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.build_sam</span> <span class=kn>import</span> <span class=n>build_sam2</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.sam2_image_predictor</span> <span class=kn>import</span> <span class=n>SAM2ImagePredictor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OLD_GPU</span><span class=p>,</span> <span class=n>USE_FLASH_ATTN</span><span class=p>,</span> <span class=n>MATH_KERNEL_ON</span> <span class=o>=</span> <span class=n>get_sdpa_settings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>OLD_GPU</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>USE_FLASH_ATTN</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>MATH_KERNEL_ON</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=n>device_type</span><span class=o>=</span><span class=s2>&#34;cuda&#34;</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>bfloat16</span><span class=p>)</span><span class=o>.</span><span class=fm>__enter__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>get_device_properties</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>major</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>matmul</span><span class=o>.</span><span class=n>allow_tf32</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>cudnn</span><span class=o>.</span><span class=n>allow_tf32</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DEVICE</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s1>&#39;cuda&#39;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s1>&#39;cpu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CHECKPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/checkpoints/sam2_hiera_large.pt&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CONFIG</span> <span class=o>=</span> <span class=s2>&#34;sam2_hiera_l.yaml&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#sam2_model = build_sam2(CONFIG, CHECKPOINT, device=DEVICE, apply_postprocessing=False)</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span> <span class=o>=</span> <span class=n>build_sam2_video_predictor</span><span class=p>(</span><span class=n>CONFIG</span><span class=p>,</span> <span class=n>CHECKPOINT</span><span class=p>,</span> <span class=n>device</span><span class=o>=</span><span class=n>DEVICE</span><span class=p>,</span> <span class=n>apply_postprocessing</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></div><p>Next we extract jpg frames from the mp4 video we uploaded to the <code>videos</code> folder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Define directories</span>
</span></span><span class=line><span class=cl><span class=n>video_dir</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/videos/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>processed_dir</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/processed&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create the processed directory if it doesn&#39;t exist</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>video_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>processed_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert_mp4_to_jpg</span><span class=p>(</span><span class=n>mp4_file</span><span class=p>,</span> <span class=n>output_folder</span><span class=p>,</span> <span class=n>one_frame_per_second</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Converts an mp4 file to high-quality jpg files.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>output_folder</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>video</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>VideoCapture</span><span class=p>(</span><span class=n>mp4_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fps</span> <span class=o>=</span> <span class=n>video</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cv2</span><span class=o>.</span><span class=n>CAP_PROP_FPS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>frame_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>saved_frame_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span><span class=p>,</span> <span class=n>frame</span> <span class=o>=</span> <span class=n>video</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>ret</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>one_frame_per_second</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Calculate the frame number to save</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>frame_count</span> <span class=o>%</span> <span class=nb>int</span><span class=p>(</span><span class=n>fps</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>output_file</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_folder</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>saved_frame_count</span><span class=si>:</span><span class=s2>04d</span><span class=si>}</span><span class=s2>.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imwrite</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=n>frame</span><span class=p>,</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>cv2</span><span class=o>.</span><span class=n>IMWRITE_JPEG_QUALITY</span><span class=p>),</span> <span class=mi>95</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>                    <span class=c1>#print(f&#34;Frame {saved_frame_count} written successfully&#34;)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to write frame </span><span class=si>{</span><span class=n>saved_frame_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>saved_frame_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>output_file</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_folder</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>frame_count</span><span class=si>:</span><span class=s2>04d</span><span class=si>}</span><span class=s2>.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>success</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imwrite</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=n>frame</span><span class=p>,</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>cv2</span><span class=o>.</span><span class=n>IMWRITE_JPEG_QUALITY</span><span class=p>),</span> <span class=mi>95</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>pass</span>
</span></span><span class=line><span class=cl>                <span class=c1>#print(f&#34;Frame {frame_count} written successfully&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failed to write frame </span><span class=si>{</span><span class=n>frame_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>frame_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>video</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mp4_file_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/videos/input_video.mp4&#34;</span>  <span class=c1># Replace with your mp4 file path</span>
</span></span><span class=line><span class=cl><span class=n>output_folder_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/processed&#34;</span>
</span></span><span class=line><span class=cl><span class=n>convert_mp4_to_jpg</span><span class=p>(</span><span class=n>mp4_file_path</span><span class=p>,</span> <span class=n>output_folder_path</span><span class=p>,</span> <span class=n>one_frame_per_second</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></div><p>Finally, we put all the frame file paths in a list for later processing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Scan all the frame names in the processed directory</span>
</span></span><span class=line><span class=cl><span class=n>processed_frame_names</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>output_folder_path</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>p</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;.jpg&#34;</span><span class=p>,</span> <span class=s2>&#34;.jpeg&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sort frame names by extracting the numerical part of the filenames</span>
</span></span><span class=line><span class=cl><span class=n>processed_frame_names</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>p</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>p</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span>
</span></span></code></pre></div><h2 id=people-detection-and-segmentation>People Detection and Segmentation</h2><h3 id=detecting-people-with-yolo>Detecting people with YOLO</h3><p>Using YOLO, we detect people in the frames and highlight those whose bounding boxes fall within a designated red zone.</p><p><img src=/blog/2024/08/01/using-yolo-people-detection-with-segment-anything-2-from-meta/image.png alt="Frame 30 with detection region masked transparent-red and blue bounding boxes from YOLO people detection"></p><p>We pick which frame to detect in and set an image_path variable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># which frame to detect on and set an image_path variable</span>
</span></span><span class=line><span class=cl><span class=n>frame_idx</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=n>image_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_folder_path</span><span class=p>,</span> <span class=n>processed_frame_names</span><span class=p>[</span><span class=n>frame_idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>image_path</span><span class=p>)</span>
</span></span></code></pre></div><p>Next we add a function to plot the detection region:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Define and add the rectangle patch with transparency</span>
</span></span><span class=line><span class=cl><span class=n>rect_x</span> <span class=o>=</span> <span class=mi>380</span>
</span></span><span class=line><span class=cl><span class=n>rect_y</span> <span class=o>=</span> <span class=mi>380</span>
</span></span><span class=line><span class=cl><span class=n>rect_width</span> <span class=o>=</span> <span class=mi>330</span>
</span></span><span class=line><span class=cl><span class=n>rect_height</span> <span class=o>=</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl><span class=c1># Define a function to plot the figure and rectangle patch</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>plot_with_rect</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>image</span><span class=p>,</span> <span class=n>rect_x</span><span class=p>,</span> <span class=n>rect_y</span><span class=p>,</span> <span class=n>rect_width</span><span class=p>,</span> <span class=n>rect_height</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Display the original image</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create and add the rectangle patch</span>
</span></span><span class=line><span class=cl>    <span class=n>rect</span> <span class=o>=</span> <span class=n>patches</span><span class=o>.</span><span class=n>Rectangle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>rect_x</span><span class=p>,</span> <span class=n>rect_y</span><span class=p>),</span> <span class=n>rect_width</span><span class=p>,</span> <span class=n>rect_height</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>facecolor</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.3</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>add_patch</span><span class=p>(</span><span class=n>rect</span><span class=p>)</span>
</span></span></code></pre></div><p>Now we perform the people detections:</p><div class="alert alert-primary"><strong class=alert-title>Tip:</strong><div class=alert-content>We are using YOLOv5 here, but there are newer version available.</div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>image_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Display the image</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>gca</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;frame </span><span class=si>{</span><span class=n>frame_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Add the patch to the Axes</span>
</span></span><span class=line><span class=cl><span class=n>plot_with_rect</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>image</span><span class=p>,</span> <span class=n>rect_x</span><span class=p>,</span> <span class=n>rect_y</span><span class=p>,</span> <span class=n>rect_width</span><span class=p>,</span> <span class=n>rect_height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load YOLO model</span>
</span></span><span class=line><span class=cl><span class=n>yolo_model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s1>&#39;yolov5su.pt&#39;</span><span class=p>)</span>  <span class=c1># Use the appropriate YOLOv5 model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load the image with OpenCV</span>
</span></span><span class=line><span class=cl><span class=n>cv2_image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>cvtColor</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>image</span><span class=p>),</span> <span class=n>cv2</span><span class=o>.</span><span class=n>COLOR_RGB2BGR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Detect objects in the image</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>yolo_model</span><span class=p>(</span><span class=n>cv2_image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Filter detections to find people</span>
</span></span><span class=line><span class=cl><span class=n>detected_people_centers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>filtered_boxes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>boxes</span><span class=o>.</span><span class=n>data</span><span class=p>:</span>  <span class=c1># Accessing the first result and its boxes</span>
</span></span><span class=line><span class=cl>    <span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>,</span> <span class=n>conf</span><span class=p>,</span> <span class=bp>cls</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>  <span class=c1># Transfer to CPU and convert to numpy array</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># Class 0 is &#39;person&#39; in COCO</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>x1</span> <span class=o>&lt;</span> <span class=n>rect_x</span> <span class=o>+</span> <span class=n>rect_width</span> <span class=ow>and</span> <span class=n>x2</span> <span class=o>&gt;</span> <span class=n>rect_x</span> <span class=ow>and</span> <span class=n>y1</span> <span class=o>&lt;</span> <span class=n>rect_y</span> <span class=o>+</span> <span class=n>rect_height</span> <span class=ow>and</span> <span class=n>y2</span> <span class=o>&gt;</span> <span class=n>rect_y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>center_x</span> <span class=o>=</span> <span class=p>(</span><span class=n>x1</span> <span class=o>+</span> <span class=n>x2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>center_y</span> <span class=o>=</span> <span class=p>(</span><span class=n>y1</span> <span class=o>+</span> <span class=n>y2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>detected_people_centers</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>center_x</span><span class=p>,</span> <span class=n>center_y</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>filtered_boxes</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># Draw bounding box</span>
</span></span><span class=line><span class=cl>            <span class=n>plt</span><span class=o>.</span><span class=n>gca</span><span class=p>()</span><span class=o>.</span><span class=n>add_patch</span><span class=p>(</span><span class=n>patches</span><span class=o>.</span><span class=n>Rectangle</span><span class=p>((</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>),</span> <span class=n>x2</span> <span class=o>-</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y2</span> <span class=o>-</span> <span class=n>y1</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=n>facecolor</span><span class=o>=</span><span class=s1>&#39;none&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Convert detected people centers to a numpy array</span>
</span></span><span class=line><span class=cl><span class=n>points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>detected_people_centers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>labels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>points</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Display the updated plot with bounding boxes</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=initializing-the-segment-anything-2-predictor>Initializing the Segment Anything 2 Predictor</h3><p>We initialize the SAM2 predictor to generate masks for each detected person as follows.</p><div class="alert alert-note"><strong class=alert-title>Note:</strong><div class=alert-content>You&rsquo;ll notice that in addition to using the point of center of the bounding boxes, we use two more points slightly above it.
This is done to improve the SAM2 detection results. The YOLO bounding box center is typically around the midsection of a
detected individual, so selecting a few points above helps ensure we target the whole individual more reliably with SAM2.</div></div><p><img src=/blog/2024/08/01/using-yolo-people-detection-with-segment-anything-2-from-meta/image-1.png alt="Frame 30 with detection region masked transparent-red and blue bounding boxes from YOLO people detection; in addition we now show the transparent masks from SAM2"></p><p>We use some functions to help us with plotting and DRYing up some detections.
These first two functions come directly from SAM2&rsquo;s example notebook:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>ax</span><span class=p>,</span> <span class=n>obj_id</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>random_color</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>random_color</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.6</span><span class=p>])],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cmap</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>get_cmap</span><span class=p>(</span><span class=s2>&#34;tab10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cmap_idx</span> <span class=o>=</span> <span class=mi>0</span> <span class=k>if</span> <span class=n>obj_id</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>obj_id</span>
</span></span><span class=line><span class=cl>        <span class=n>color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=o>*</span><span class=n>cmap</span><span class=p>(</span><span class=n>cmap_idx</span><span class=p>)[:</span><span class=mi>3</span><span class=p>],</span> <span class=mf>0.6</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>mask_image</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>color</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>mask_image</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_points</span><span class=p>(</span><span class=n>coords</span><span class=p>,</span> <span class=n>labels</span><span class=p>,</span> <span class=n>ax</span><span class=p>,</span> <span class=n>marker_size</span><span class=o>=</span><span class=mi>200</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pos_points</span> <span class=o>=</span> <span class=n>coords</span><span class=p>[</span><span class=n>labels</span><span class=o>==</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>neg_points</span> <span class=o>=</span> <span class=n>coords</span><span class=p>[</span><span class=n>labels</span><span class=o>==</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>pos_points</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>pos_points</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>marker_size</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;white&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>1.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>neg_points</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>neg_points</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>marker_size</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;white&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>1.25</span><span class=p>)</span> 
</span></span></code></pre></div><p>We also have a few helper functions to make our code DRY/cleaner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>find_center_point</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cx</span> <span class=o>=</span> <span class=p>(</span><span class=n>x1</span> <span class=o>+</span> <span class=n>x2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>cy</span> <span class=o>=</span> <span class=p>(</span><span class=n>y1</span> <span class=o>+</span> <span class=n>y2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[(</span><span class=n>cx</span><span class=p>,</span> <span class=n>cy</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_points_around_bbox</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>,</span> <span class=n>distance</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cx</span> <span class=o>=</span> <span class=p>(</span><span class=n>x1</span> <span class=o>+</span> <span class=n>x2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>cy</span> <span class=o>=</span> <span class=p>(</span><span class=n>y1</span> <span class=o>+</span> <span class=n>y2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[(</span><span class=n>cx</span><span class=p>,</span> <span class=n>cy</span><span class=p>),</span> <span class=p>(</span><span class=n>cx</span><span class=p>,</span> <span class=n>cy</span> <span class=o>+</span> <span class=n>distance</span><span class=p>),</span> <span class=p>(</span><span class=n>cx</span><span class=p>,</span> <span class=n>cy</span> <span class=o>-</span> <span class=mi>3</span><span class=o>*</span><span class=n>distance</span><span class=p>)]</span>
</span></span></code></pre></div><p>This is the important loop that applies SAM2 to the detected individuals:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.utils.misc</span> <span class=kn>import</span> <span class=n>get_sdpa_settings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.build_sam</span> <span class=kn>import</span> <span class=n>build_sam2_video_predictor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OLD_GPU</span><span class=p>,</span> <span class=n>USE_FLASH_ATTN</span><span class=p>,</span> <span class=n>MATH_KERNEL_ON</span> <span class=o>=</span> <span class=n>get_sdpa_settings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>DEVICE</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s1>&#39;cuda&#39;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s1>&#39;cpu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CHECKPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>/checkpoints/sam2_hiera_large.pt&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CONFIG</span> <span class=o>=</span> <span class=s2>&#34;sam2_hiera_l.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span> <span class=o>=</span> <span class=n>build_sam2_video_predictor</span><span class=p>(</span><span class=n>CONFIG</span><span class=p>,</span> <span class=n>CHECKPOINT</span><span class=p>,</span> <span class=n>device</span><span class=o>=</span><span class=n>DEVICE</span><span class=p>,</span> <span class=n>apply_postprocessing</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load and display the initial frame with masks</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>ax</span><span class=p>,</span> <span class=n>obj_id</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>random_color</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>random_color</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>random</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>0.6</span><span class=p>])],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cmap</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>get_cmap</span><span class=p>(</span><span class=s2>&#34;tab10&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cmap_idx</span> <span class=o>=</span> <span class=mi>0</span> <span class=k>if</span> <span class=n>obj_id</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>obj_id</span>
</span></span><span class=line><span class=cl>        <span class=n>color</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=o>*</span><span class=n>cmap</span><span class=p>(</span><span class=n>cmap_idx</span><span class=p>)[:</span><span class=mi>3</span><span class=p>],</span> <span class=mf>0.6</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=n>mask_image</span> <span class=o>=</span> <span class=n>mask</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=n>w</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>color</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>mask_image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show_points</span><span class=p>(</span><span class=n>coords</span><span class=p>,</span> <span class=n>labels</span><span class=p>,</span> <span class=n>ax</span><span class=p>,</span> <span class=n>marker_size</span><span class=o>=</span><span class=mi>200</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>pos_points</span> <span class=o>=</span> <span class=n>coords</span><span class=p>[</span><span class=n>labels</span><span class=o>==</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>neg_points</span> <span class=o>=</span> <span class=n>coords</span><span class=p>[</span><span class=n>labels</span><span class=o>==</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>pos_points</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>pos_points</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;green&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>marker_size</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;white&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>1.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>neg_points</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>pos_points</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;red&#39;</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>marker_size</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;white&#39;</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mf>1.25</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>inference_mode</span><span class=p>(),</span> <span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=s2>&#34;cuda&#34;</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>bfloat16</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>inference_state</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>init_state</span><span class=p>(</span><span class=n>video_path</span><span class=o>=</span><span class=n>output_folder_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>gca</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># Display the original image</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Add the patch to the Axes</span>
</span></span><span class=line><span class=cl>    <span class=n>plot_with_rect</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>image</span><span class=p>,</span> <span class=n>rect_x</span><span class=p>,</span> <span class=n>rect_y</span><span class=p>,</span> <span class=n>rect_width</span><span class=p>,</span> <span class=n>rect_height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Track initial masks for each detected person</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_points</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_masks</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ann_obj_id</span><span class=p>,</span> <span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>filtered_boxes</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Generate points within the bounding box and additional points above and below</span>
</span></span><span class=line><span class=cl>        <span class=n>bbox_height</span> <span class=o>=</span> <span class=n>y2</span> <span class=o>-</span> <span class=n>y1</span>
</span></span><span class=line><span class=cl>        <span class=n>additional_distance</span> <span class=o>=</span> <span class=mf>0.05</span> <span class=o>*</span> <span class=n>bbox_height</span>
</span></span><span class=line><span class=cl>        <span class=n>extended_points</span> <span class=o>=</span> <span class=n>add_points_around_bbox</span><span class=p>(</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>,</span> <span class=n>x2</span><span class=p>,</span> <span class=n>y2</span><span class=p>,</span> <span class=n>additional_distance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>extended_points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>extended_points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>extended_labels</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>extended_points</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Store the initial points for later use</span>
</span></span><span class=line><span class=cl>        <span class=n>initial_points</span><span class=p>[</span><span class=n>ann_obj_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>extended_points</span><span class=p>,</span> <span class=n>extended_labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Add new points for the first frame (using the extended points)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>extended_points</span><span class=o>.</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>predictor</span><span class=o>.</span><span class=n>reset_state</span><span class=p>(</span><span class=n>inference_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>_</span><span class=p>,</span> <span class=n>out_obj_ids</span><span class=p>,</span> <span class=n>out_mask_logits</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>add_new_points</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>inference_state</span><span class=o>=</span><span class=n>inference_state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>frame_idx</span><span class=o>=</span><span class=n>frame_idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>obj_id</span><span class=o>=</span><span class=n>ann_obj_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>points</span><span class=o>=</span><span class=n>extended_points</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>labels</span><span class=o>=</span><span class=n>extended_labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>initial_masks</span><span class=p>[</span><span class=n>ann_obj_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>out_mask_logits</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.0</span><span class=p>)</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Draw the YOLO bounding box</span>
</span></span><span class=line><span class=cl>            <span class=n>ax</span><span class=o>.</span><span class=n>add_patch</span><span class=p>(</span><span class=n>patches</span><span class=o>.</span><span class=n>Rectangle</span><span class=p>((</span><span class=n>x1</span><span class=p>,</span> <span class=n>y1</span><span class=p>),</span> <span class=n>x2</span> <span class=o>-</span> <span class=n>x1</span><span class=p>,</span> <span class=n>y2</span> <span class=o>-</span> <span class=n>y1</span><span class=p>,</span> <span class=n>linewidth</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>edgecolor</span><span class=o>=</span><span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=n>facecolor</span><span class=o>=</span><span class=s1>&#39;none&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Overlay the SAM2 mask</span>
</span></span><span class=line><span class=cl>            <span class=n>show_mask</span><span class=p>(</span><span class=n>initial_masks</span><span class=p>[</span><span class=n>ann_obj_id</span><span class=p>],</span> <span class=n>ax</span><span class=p>,</span> <span class=n>obj_id</span><span class=o>=</span><span class=n>ann_obj_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>show_points</span><span class=p>(</span><span class=n>extended_points</span><span class=p>,</span> <span class=n>extended_labels</span><span class=p>,</span> <span class=n>ax</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Show the final plot with the highlighted people</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=propagating-sam2-detections-forward-throughout-the-video>Propagating SAM2 Detections Forward Throughout the Video</h3><p>We propagate the masks generated in the first frame through the entire video.</p><div class="alert alert-info"><strong class=alert-title>Note:</strong><div class=alert-content>The way we are doing this here is not
efficient as we are propagating one detected person at a time, and then applying the masks later to the final image. This was
done because detecting multiple people at once was showing some unwanted artifacts. In a future iteration of this, we will try
to do the propegation for all detected points at the same time rather than via loops.</div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Initialize a dictionary to store masks per frame per person</span>
</span></span><span class=line><span class=cl><span class=n>video_segments</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run propagation for each detected person individually</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>inference_mode</span><span class=p>(),</span> <span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=s2>&#34;cuda&#34;</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>bfloat16</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ann_obj_id</span><span class=p>,</span> <span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span> <span class=ow>in</span> <span class=n>initial_points</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=c1># Reset the state for the current object</span>
</span></span><span class=line><span class=cl>        <span class=n>inference_state</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>init_state</span><span class=p>(</span><span class=n>video_path</span><span class=o>=</span><span class=n>output_folder_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>predictor</span><span class=o>.</span><span class=n>reset_state</span><span class=p>(</span><span class=n>inference_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>predictor</span><span class=o>.</span><span class=n>add_new_points</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>inference_state</span><span class=o>=</span><span class=n>inference_state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>frame_idx</span><span class=o>=</span><span class=n>frame_idx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>obj_id</span><span class=o>=</span><span class=n>ann_obj_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>points</span><span class=o>=</span><span class=n>points</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>labels</span><span class=o>=</span><span class=n>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Propagate the masks for the current object throughout the video</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>out_frame_idx</span><span class=p>,</span> <span class=n>out_obj_ids</span><span class=p>,</span> <span class=n>out_mask_logits</span> <span class=ow>in</span> <span class=n>predictor</span><span class=o>.</span><span class=n>propagate_in_video</span><span class=p>(</span><span class=n>inference_state</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>out_frame_idx</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>video_segments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>video_segments</span><span class=p>[</span><span class=n>out_frame_idx</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>ann_obj_id</span> <span class=ow>in</span> <span class=n>out_obj_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>video_segments</span><span class=p>[</span><span class=n>out_frame_idx</span><span class=p>][</span><span class=n>ann_obj_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>out_mask_logits</span><span class=p>[</span><span class=n>out_obj_ids</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>ann_obj_id</span><span class=p>)]</span> <span class=o>&gt;</span> <span class=mf>0.0</span><span class=p>)</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>
</span></span></code></pre></div><p>We save the output frames as PNG for better quality (though at a cost of more disk space):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Define the output directory for the frames</span>
</span></span><span class=line><span class=cl><span class=n>output_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s1>&#39;output_frames&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Render the segmentation results every x frame and save as PNG</span>
</span></span><span class=line><span class=cl><span class=n>vis_frame_stride</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=s2>&#34;all&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>frame_paths</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>out_frame_idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>processed_frame_names</span><span class=p>),</span> <span class=n>vis_frame_stride</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;frame </span><span class=si>{</span><span class=n>out_frame_idx</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>processed_dir</span><span class=p>,</span> <span class=n>processed_frame_names</span><span class=p>[</span><span class=n>out_frame_idx</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>out_frame_idx</span> <span class=ow>in</span> <span class=n>video_segments</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>out_obj_id</span><span class=p>,</span> <span class=n>out_mask</span> <span class=ow>in</span> <span class=n>video_segments</span><span class=p>[</span><span class=n>out_frame_idx</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>show_mask</span><span class=p>(</span><span class=n>out_mask</span><span class=p>,</span> <span class=n>plt</span><span class=o>.</span><span class=n>gca</span><span class=p>(),</span> <span class=n>obj_id</span><span class=o>=</span><span class=n>out_obj_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>frame_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output_dir</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;frame_</span><span class=si>{</span><span class=n>out_frame_idx</span><span class=si>:</span><span class=s2>04d</span><span class=si>}</span><span class=s2>.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>frame_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>frame_paths</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>frame_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=generating-the-output-video>Generating the Output Video</h2><p>Finally, we compile the processed frames into an output video.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>moviepy.editor</span> <span class=kn>import</span> <span class=n>VideoFileClip</span><span class=p>,</span> <span class=n>ImageSequenceClip</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Path to the input video</span>
</span></span><span class=line><span class=cl><span class=n>input_video_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s1>&#39;videos&#39;</span><span class=p>,</span> <span class=s1>&#39;input_video.mp4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Detect the frame rate of the input video</span>
</span></span><span class=line><span class=cl><span class=n>video_clip</span> <span class=o>=</span> <span class=n>VideoFileClip</span><span class=p>(</span><span class=n>input_video_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>frame_rate</span> <span class=o>=</span> <span class=n>video_clip</span><span class=o>.</span><span class=n>fps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a video from the saved frames using moviepy</span>
</span></span><span class=line><span class=cl><span class=n>video_output_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>HOME</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s1>&#39;videos&#39;</span><span class=p>,</span> <span class=s1>&#39;output_video.mp4&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>clip</span> <span class=o>=</span> <span class=n>ImageSequenceClip</span><span class=p>(</span><span class=n>frame_paths</span><span class=p>,</span> <span class=n>fps</span><span class=o>=</span><span class=n>frame_rate</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>clip</span><span class=o>.</span><span class=n>write_videofile</span><span class=p>(</span><span class=n>video_output_path</span><span class=p>,</span> <span class=n>codec</span><span class=o>=</span><span class=s1>&#39;libx264&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>The resulting video demonstrates how SAM2 maintains distinct object tracking throughout the video duration:</p><div class=video-container><iframe width=560 height=315 src=https://www.youtube.com/embed/3IbUXK2mydY frameborder=0 allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><br><p>Note how the occlusion of the person masked in green by the person masked in orange does not cause the loss of
tracking for the person masked in green. Even more impressive, the person masked in red is not lost by SAM2 despite being heavily occluded.</p><h2 id=conclusions>Conclusions</h2><p>We demonstrated a way to detect and track people seen passing through a designated detection region in a video using YOLO to
bootstrap SAM2. Next steps include:</p><ul><li>Cleaning up the code, de-looping the detection (see note in the SAM2 process section)</li><li>Dockerizing this process</li><li>Exploring monocular depth estimation as a way to more accurately detect proximity:<ul><li>Monocular depth estimation uses trained models that can pick up lighting cues to recreate the information related to the z axis in 2D video.</li><li>In a subset of cases (perhaps even the majority of cases?), this recreation of z-axis depth perception is accurate enough to provide reliable detection of proximity in all three dimensions of space.</li><li>Monocular depth estimation is being studied, for example, <a href=https://medium.com/toyotaresearch/monocular-depth-in-the-real-world-99c2b287df34>by Toyota</a> in regards to autonomous vehicle driving. Further, the related field of Gaussian Splat is a very <a href=https://github.com/MrNeRF/awesome-3D-gaussian-splatting/blob/main/README.md>active area of research</a>.</li></ul></li></ul></article></main><footer id=footer><div><span>Powered by <a class=link href=https://gohugo.io target=_blank rel=noopener>Hugo</a> |
Theme <a class=link href=https://github.com/michaelneuper/hugo-texify3 target=_blank rel=noopener>TeXify3</a></span></div><div><span>Copyright © 2025</span></div></footer></div><script src=https://www.tdj28.org/js/script.js defer></script></body></html>